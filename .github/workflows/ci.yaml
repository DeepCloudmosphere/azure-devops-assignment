name: CI â€” PR checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  id-token: write

jobs:
  python-tests:
    name: Run Python tests (user & order)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [user-service, order-service]
    defaults:
      run:
        working-directory: ${{ matrix.service }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: Run pytest
        # ensure the service directory is on PYTHONPATH so `from app import app` works
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          pytest -q

  gateway-tests:
    name: Gateway quick check (install)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: gateway
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install gateway deps
        run: |
          # use 'npm install' if no package-lock.json is present
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          
      - name: Run gateway tests
        run: npm tes
